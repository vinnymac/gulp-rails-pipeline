#!upstart
description "Autostart jubjub"

start on runlevel [2345]
stop on shutdown

respawn
# If we restart more than X times in Y seconds, give up.
respawn limit 10 60

env NODE_PATH="{{ nodejs_app.node_path }}"
env APP_DIR="{{ nodejs_app.dir }}"
env SCRIPT="{{ nodejs_app.service }}.js"
env LOG="{{ nodejs_app.log_file }}"
env PIDFILE="{{ nodejs_app.pid_file }}"
env NODE_ENV="{{ nodejs_app.env.NODE_ENV }}"
env NODE_CONFIG_DIR="{{ nodejs_app.dir }}/config"

script
    . /etc/environment
    export NODE_ENV
    # Put a message in the logs with a timestamp, indicating that we're
    # starting the app
    echo "*** `date -u +%Y-%m-%dT%T.%3NZ`: Jubjub started by upstart ***" >> $LOG
    echo $$ >> $PIDFILE
    exec $NODE_PATH $APP_DIR/$SCRIPT >> $LOG 2>&1
end script

post-stop script
    echo "*** `date -u +%Y-%m-%dT%T.%3NZ`: Jubjub stopped by upstart ***" >> $LOG
    rm -f $PIDFILE
end script
