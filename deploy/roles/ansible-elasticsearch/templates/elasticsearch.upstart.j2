#!upstart
description "ElasticSearch"

start on net-device-up IFACE=lo
stop on runlevel [016]

respawn
# If we restart more than X times in Y seconds, give up.
respawn limit 10 60

env PIDFILE="{{ elasticsearch_pidfile }}"
env LOGFILE="{{ elasticsearch_logfile }}"

script
    . /etc/environment
    . /etc/default/elasticsearch

export ES_HEAP_SIZE
export ES_HEAP_NEWSIZE
export ES_DIRECT_SIZE
export ES_JAVA_OPTS
export MAX_LOCKED_MEMORY
export ES_JAVA_OPTS

    # Put a message in the logs with a timestamp, indicating that we're
    # starting the app
    echo "*** `date -u +%Y-%m-%dT%T.%3NZ`: ElasticSearch started by upstart ***" >> $LOGFILE
    echo $$ >> $PIDFILE
    exec /usr/share/elasticsearch/bin/elasticsearch >> $LOGFILE 2>&1
end script

post-stop script
    echo "*** `date -u +%Y-%m-%dT%T.%3NZ`: ElasticSearch stopped by upstart ***" >> $LOGFILE
    rm -f $PIDFILE
end script
